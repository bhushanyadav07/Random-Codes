document.addEventListener('DOMContentLoaded', function() {
    let submitBtn = document.getElementById('submitBtn');
    let csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    let editMode = false;
    let editId = null;

    // Submit or Update
    submitBtn.addEventListener('click', function() {
        let empNumber = document.getElementById('emp_number').value.trim();
        let menuOption = document.getElementById('menu_options').value.trim();

        if (!empNumber || !menuOption) {
            alert("Please fill all fields.");
            return;
        }

        let url = editMode ? `/update/${editId}` : "/store";
        let method = editMode ? "PUT" : "POST";

        fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-TOKEN": csrfToken
            },
            body: JSON.stringify({
                emp_number: empNumber,
                menu_options: menuOption
            })
        })
        .then(res => {
            if (!res.ok) throw new Error("Network response was not ok");
            return res.json();
        })
        .then(data => {
            if (data.success) {
                fetchRecords();
                resetForm();
            } else {
                alert("Something went wrong. Please try again.");
            }
        })
        .catch(err => {
            console.error("AJAX Error:", err);
            alert("Error connecting to server.");
        });
    });

    // Fetch all records
    function fetchRecords() {
        fetch("/fetch")
        .then(res => {
            if (!res.ok) throw new Error("Network response was not ok");
            return res.json();
        })
        .then(data => {
            let tableBody = document.getElementById('recordsTable');
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align:center;">No Data</td>
                    </tr>
                `;
                return;
            }

            data.forEach(record => {
                tableBody.innerHTML += `
                    <tr>
                        <td>${record.id}</td>
                        <td>${record.emp_number}</td>
                        <td>${record.menu_options}</td>
                        <td>
                            <button class="editBtn" data-id="${record.id}" 
                                data-emp="${record.emp_number}" 
                                data-menu="${record.menu_options}">
                                Edit
                            </button>
                        </td>
                    </tr>
                `;
            });

            attachEditEvents();
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            document.getElementById('recordsTable').innerHTML = 
                '<tr><td colspan="4" style="text-align:center;color:red;">Error fetching data</td></tr>';
        });
    }

    // Attach edit events
    function attachEditEvents() {
        document.querySelectorAll('.editBtn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('emp_number').value = this.dataset.emp;
                document.getElementById('menu_options').value = this.dataset.menu;
                submitBtn.textContent = "Update";
                editMode = true;
                editId = this.dataset.id;
            });
        });
    }

    // Reset form
    function resetForm() {
        document.getElementById('emp_number').value = '';
        document.getElementById('menu_options').value = '';
        submitBtn.textContent = "Submit";
        editMode = false;
        editId = null;
    }

    // Initial fetch
    fetchRecords();
});
