//attachment files

<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class AttachmentController extends Controller
{
    public function upload(Request $request)
    {
        // ðŸ”¢ Get ID dynamically from request
        $id = (int) $request->input('id');

        $year = date('Y');

        // ðŸ“ public/storage/uploads/{year}/{id}
        $uploadDir = public_path("storage/uploads/{$year}/{$id}");

        // Create directory once (cheap)
        if (!is_dir($uploadDir)) {
            mkdir($uploadDir, 0755, true);
        }

        $uploadedFiles = [];

        $keys = [
            'attachment_file1',
            'attachment_file2',
            'attachment_file3',
            'attachment_file4',
        ];

        foreach ($keys as $key) {

            if (!$request->hasFile($key)) {
                continue;
            }

            $file = $request->file($key);

            if (!$file->isValid()) {
                continue;
            }

            // ðŸ” Safe original filename
            $nameOnly = pathinfo(
                $file->getClientOriginalName(),
                PATHINFO_FILENAME
            );

            // Your logic: last 7 characters
            $nameOnly = substr($nameOnly, -7);

            $extension = $file->getClientOriginalExtension();

            // âš¡ Fast filename
            $filename = $id . '_' . time() . '_' . $nameOnly . '.' . $extension;

            // ðŸš€ FAST MOVE
            $file->move($uploadDir, $filename);

            // ðŸŒ Public URL
            $uploadedFiles[$key] = "/storage/uploads/{$year}/{$id}/{$filename}";
        }

        return response()->json([
            'status' => true,
            'files' => $uploadedFiles
        ]);
    }
}
